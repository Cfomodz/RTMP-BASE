<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamDrop Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>
                        <i class="fas fa-broadcast-tower"></i>
                        ðŸŽ¬ StreamDrop
                    </h1>
                    <p>Pygame Streaming Platform for YouTube</p>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="color: #718096; font-size: 0.9em;">Welcome back!</span>
                    <a href="/logout" class="btn btn-secondary" style="text-decoration: none; padding: 8px 16px; border-radius: 6px; font-size: 0.9em;">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-play-circle stat-icon" style="color: #48bb78;"></i>
                <h3>Active Streams</h3>
                <div class="stat-value" id="activeStreams">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-clock stat-icon" style="color: #4299e1;"></i>
                <h3>Total Uptime</h3>
                <div class="stat-value" id="totalUptime">0h</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-gamepad stat-icon" style="color: #9f7aea;"></i>
                <h3>Pygame Streams</h3>
                <div class="stat-value" id="totalStreams">0</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-server stat-icon" style="color: #ed8936;"></i>
                <h3>System Status</h3>
                <div class="stat-value" id="systemStatus">OK</div>
            </div>
        </div>

        <!-- Streams Management -->
        <div class="streams-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-gamepad"></i>
                    Pygame Streams
                </h2>
                <div style="display: flex; gap: 15px;">
                    <button class="btn btn-primary" onclick="openCreateStreamModal()">
                        <i class="fas fa-plus"></i>
                        Create New Stream
                    </button>
                </div>
            </div>

            <div class="stream-grid" id="streamGrid">
                <!-- Stream cards will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Create Stream Modal -->
    <div id="createStreamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Create New Pygame Stream</h3>
                <span class="close" onclick="closeModal('createStreamModal')">&times;</span>
            </div>
            <form id="createStreamForm">
                <div class="form-group">
                    <label class="form-label">Stream Name</label>
                    <input type="text" class="form-input" name="name" placeholder="My Pygame Stream" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stream Type</label>
                    <select class="form-input" name="type" required>
                        <option value="pygame">Pygame Game</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Platform</label>
                    <select class="form-input" name="platform" id="platformSelect" required>
                        <option value="youtube">YouTube Live</option>
                        <option value="custom">Custom RTMP</option>
                    </select>
                </div>
                
                <div class="form-group" id="customRtmpGroup" style="display: none;">
                    <label class="form-label">Custom RTMP URL</label>
                    <input type="text" class="form-input" name="rtmp_url" placeholder="rtmp://your-server.com/live">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stream Key</label>
                    <input type="password" class="form-input" name="stream_key" placeholder="Your stream key" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Quality Preset</label>
                    <select class="form-input" name="quality" required>
                        <option value="low">Low (854x480, 1000k, 24fps)</option>
                        <option value="medium" selected>Medium (1280x720, 2500k, 30fps)</option>
                        <option value="high">High (1920x1080, 4000k, 30fps)</option>
                        <option value="ultra">Ultra (1920x1080, 6000k, 60fps)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Game Script Path</label>
                    <input type="text" class="form-input" name="source" placeholder="/path/to/your/game.py" required>
                    <div class="form-help">Path to your pygame script with a render(screen) function</div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createStreamModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Stream</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Stream Modal -->
    <div id="editStreamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit Pygame Stream</h3>
                <span class="close" onclick="closeModal('editStreamModal')">&times;</span>
            </div>
            <form id="editStreamForm">
                <input type="hidden" name="stream_id">
                
                <div class="form-group">
                    <label class="form-label">Stream Name</label>
                    <input type="text" class="form-input" name="name" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Quality Preset</label>
                    <select class="form-input" name="quality" required>
                        <option value="low">Low (854x480, 1000k, 24fps)</option>
                        <option value="medium">Medium (1280x720, 2500k, 30fps)</option>
                        <option value="high">High (1920x1080, 4000k, 30fps)</option>
                        <option value="ultra">Ultra (1920x1080, 6000k, 60fps)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Game Script Path</label>
                    <input type="text" class="form-input" name="source" required>
                    <div class="form-help">Path to your pygame script with a render(screen) function</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stream Key</label>
                    <input type="password" class="form-input" name="stream_key">
                    <div class="form-help">Leave blank to keep current key</div>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editStreamModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Stream</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toast" class="toast"></div>

    <script>
        // Global state
        let streams = [];
        let updateInterval;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadStreams();
            updateStats();
            setupFormHandlers();
            
            // Set up auto-refresh
            updateInterval = setInterval(() => {
                loadStreams();
                updateStats();
            }, 5000);
        });
        
        // Setup form handlers
        function setupFormHandlers() {
            // Platform selection handler
            const platformSelect = document.getElementById('platformSelect');
            const customRtmpGroup = document.getElementById('customRtmpGroup');
            
            if (platformSelect) {
                platformSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        customRtmpGroup.style.display = 'block';
                    } else {
                        customRtmpGroup.style.display = 'none';
                    }
                });
            }
        }

        // Load streams from server
        async function loadStreams() {
            try {
                const response = await fetch('/api/streams');
                if (response.ok) {
                    streams = await response.json();
                    renderStreams();
                }
            } catch (error) {
                console.error('Error loading streams:', error);
            }
        }

        // Render stream cards
        function renderStreams() {
            const grid = document.getElementById('streamGrid');
            
            if (streams.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #718096;">
                        <i class="fas fa-gamepad" style="font-size: 3em; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3>No pygame streams configured</h3>
                        <p>Create your first pygame stream to get started</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = streams.map(stream => `
                <div class="stream-card">
                    <div class="stream-header">
                        <div class="stream-title">${stream.name}</div>
                        <span class="stream-status status-${stream.status}">${stream.status}</span>
                    </div>
                    <div class="stream-info">
                        <div class="info-row">
                            <span class="info-label">Platform</span>
                            <span class="info-value">${stream.platform.charAt(0).toUpperCase() + stream.platform.slice(1)}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Quality</span>
                            <span class="info-value">${stream.quality || 'Medium'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Game Script</span>
                            <span class="info-value" title="${stream.source || stream.game_script || ''}">${(stream.source || stream.game_script || '').length > 30 ? (stream.source || stream.game_script || '').substring(0, 30) + '...' : (stream.source || stream.game_script || '')}</span>
                        </div>
                    </div>
                    <div class="stream-controls">
                        ${stream.status === 'stopped' ? 
                            `<button class="btn btn-success" onclick="startStream('${stream.id}')">
                                <i class="fas fa-play"></i> Start
                            </button>` : 
                            `<button class="btn btn-danger" onclick="stopStream('${stream.id}')">
                                <i class="fas fa-stop"></i> Stop
                            </button>`
                        }
                        <button class="btn btn-secondary" onclick="editStream('${stream.id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-secondary" onclick="deleteStream('${stream.id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Update statistics
        function updateStats() {
            const activeCount = streams.filter(s => s.status === 'live').length;
            document.getElementById('activeStreams').textContent = activeCount;
            document.getElementById('totalStreams').textContent = streams.length;
            
            // Calculate total uptime (placeholder for now)
            const totalMinutes = streams.reduce((sum, stream) => {
                return sum + (stream.uptimeMinutes || 0);
            }, 0);
            
            const hours = Math.floor(totalMinutes / 60);
            document.getElementById('totalUptime').textContent = hours + 'h';
        }

        // Modal functions
        function openCreateStreamModal() {
            document.getElementById('createStreamModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Stream management functions
        async function startStream(streamId) {
            try {
                const response = await fetch(`/api/streams/${streamId}/start`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Stream started successfully!', 'success');
                    loadStreams();
                } else {
                    showToast(data.message || 'Failed to start stream', 'error');
                }
            } catch (error) {
                showToast('Error starting stream', 'error');
            }
        }

        async function stopStream(streamId) {
            try {
                const response = await fetch(`/api/streams/${streamId}/stop`, { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Stream stopped successfully!', 'success');
                    loadStreams();
                } else {
                    showToast(data.message || 'Failed to stop stream', 'error');
                }
            } catch (error) {
                showToast('Error stopping stream', 'error');
            }
        }

        function editStream(streamId) {
            // Find the stream data
            const stream = streams.find(s => s.id === streamId);
            if (!stream) {
                showToast('Stream not found', 'error');
                return;
            }
            
            // Populate the edit form
            const form = document.getElementById('editStreamForm');
            form.stream_id.value = stream.id;
            form.name.value = stream.name || '';
            form.quality.value = stream.quality || 'medium';
            form.source.value = stream.source || stream.game_script || '';
            form.stream_key.value = ''; // Don't pre-fill sensitive data
            
            // Show the modal
            document.getElementById('editStreamModal').style.display = 'block';
        }

        async function deleteStream(streamId) {
            if (!confirm('Are you sure you want to delete this stream?')) return;
            
            try {
                const response = await fetch(`/api/streams/${streamId}`, { method: 'DELETE' });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Stream deleted successfully!', 'success');
                    loadStreams();
                } else {
                    showToast(data.message || 'Failed to delete stream', 'error');
                }
            } catch (error) {
                showToast('Error deleting stream', 'error');
            }
        }

        // Create stream form handler
        document.getElementById('createStreamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const streamData = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/streams', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(streamData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Stream created successfully!', 'success');
                    closeModal('createStreamModal');
                    this.reset();
                    loadStreams();
                } else {
                    showToast(data.message || 'Failed to create stream', 'error');
                }
            } catch (error) {
                showToast('Error creating stream', 'error');
            }
        });
        
        // Edit stream form handler
        document.getElementById('editStreamForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const streamData = Object.fromEntries(formData.entries());
            const streamId = streamData.stream_id;
            delete streamData.stream_id;
            
            // Don't send empty stream key
            if (!streamData.stream_key) {
                delete streamData.stream_key;
            }
            
            try {
                const response = await fetch(`/api/streams/${streamId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(streamData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Stream updated successfully!', 'success');
                    closeModal('editStreamModal');
                    loadStreams();
                } else {
                    showToast(data.message || 'Failed to update stream', 'error');
                }
            } catch (error) {
                showToast('Error updating stream', 'error');
            }
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;
            
            setTimeout(() => {
                toast.className = `toast toast-${type}`;
            }, 3000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>